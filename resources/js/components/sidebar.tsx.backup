import { SidebarItem } from "./library/sidebar-item"
import { Button } from "./ui/button"
import { usePage } from "@inertiajs/react"
import { Modals } from "@/hooks/useModals"
import type { InertiaPageProps } from "@/types"
import { useState, useMemo } from "react"
import {
	DropdownMenu,
	DropdownMenuContent,
	DropdownMenuItem,
	DropdownMenuTrigger,
	DropdownMenuSeparator,
	DropdownMenuLabel,
} from "@/components/ui/dropdown-menu"
import {
	ContextMenu,
	ContextMenuContent,
	ContextMenuItem,
	ContextMenuTrigger,
} from "@/components/ui/context-menu"

interface SidebarProps {
	isExpanded: boolean
	setIsExpanded: React.Dispatch<React.SetStateAction<boolean>>
	isMobile?: boolean
	onClose?: () => void
}

type FilterTab = "playlists" | "artists" | "albums"
type SortOption = "recents" | "recently_added" | "alphabetical" | "creator"
type ViewOption = "list" | "compact" | "grid" | "large-grid"

export default function Sidebar({
	isExpanded,
	setIsExpanded,
	isMobile = false,
	onClose,
}: SidebarProps) {
	const { playlists, savedAlbums, followedArtists } = usePage()
		.props as unknown as InertiaPageProps
	const { setOpen: setEditPlaylistDetailsModalOpen } =
		Modals.useEditPlaylistDetailsModal()

	const [activeTab, setActiveTab] = useState<FilterTab>("playlists")
	const [sortBy, setSortBy] = useState<SortOption>("recents")
	const [viewAs, setViewAs] = useState<ViewOption>("list")

	// Sort playlists based on selected option
	const sortedPlaylists = useMemo(() => {
		const sorted = [...playlists]
		switch (sortBy) {
			case "recents":
				// TODO: Implement recents based on last accessed time
				return sorted
			case "recently_added":
				return sorted.sort(
					(a, b) =>
						new Date(b.created_at || 0).getTime() -
						new Date(a.created_at || 0).getTime()
				)
			case "alphabetical":
				return sorted.sort((a, b) => a.name.localeCompare(b.name))
			case "creator":
				// TODO: Implement creator sorting when user info is available
				return sorted
			default:
				return sorted
		}
	}, [playlists, sortBy])

	// On mobile, always show expanded version
	const shouldShowExpanded = isMobile || isExpanded

	if (!shouldShowExpanded && !isMobile) {
		return (
			<div className="flex flex-col justify-center items-center gap-2 py-4">
				<Button
					variant="spotifyTransparent"
					size="icon"
					className="group"
					onClick={() => setIsExpanded(true)}
				>
					<svg
						data-encore-id="icon"
						role="img"
						aria-hidden="true"
						viewBox="0 0 24 24"
						fill="gray"
						className="min-w-6 min-h-6 transition-colors duration-300 group-hover:fill-white"
					>
						<path d="M14.457 15.207a1 1 0 0 1-1.414-1.414L14.836 12l-1.793-1.793a1 1 0 0 1 1.414-1.414l2.5 2.5a1 1 0 0 1 0 1.414z"></path>
						<path d="M20 22a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2zM4 20V4h4v16zm16 0H10V4h10z"></path>
					</svg>
				</Button>

				<Button
					variant="spotifyTransparent"
					size="icon"
					className="group bg-zinc-800 w-8 h-8"
				>
					<svg
						data-encore-id="icon"
						role="img"
						aria-hidden="true"
						viewBox="0 0 16 16"
						fill="gray"
						className="min-w-4 min-h-4 transition-colors duration-300 group-hover:fill-white"
					>
						<path d="M15.25 8a.75.75 0 0 1-.75.75H8.75v5.75a.75.75 0 0 1-1.5 0V8.75H1.5a.75.75 0 0 1 0-1.5h5.75V1.5a.75.75 0 0 1 1.5 0v5.75h5.75a.75.75 0 0 1 .75.75"></path>
					</svg>
				</Button>

				<div className="mt-2">
					{playlists.slice(0, 5).map((playlist) => (
						<SidebarItem
							key={playlist.id}
							id={String(playlist.id)}
							title={playlist.name}
							tracks={playlist.tracks}
							description={playlist.description}
							image={playlist.image}
							href={`/playlist/${playlist.id}`}
							isCollapsed
							isLikedSongs={playlist.is_default}
						/>
					))}
				</div>
			</div>
		)
	}

	return (
		<div className="h-full flex flex-col bg-[#121212]">
			<div className="flex justify-between items-center px-4 py-2">
				<div className="flex items-center gap-3">
					<span className="text-[#b3b3b3] text-base font-bold hover:text-white transition-colors cursor-pointer">
						Your Library
					</span>
				</div>
				<div className="flex items-center gap-2">
					<DropdownMenu>
						<DropdownMenuTrigger asChild>
							<Button
								variant="spotifyTransparent"
								size="icon"
								className="group w-8 h-8"
							>
								<svg
									viewBox="0 0 16 16"
									fill="#b3b3b3"
									className="w-4 h-4 transition-colors duration-200 group-hover:fill-white"
								>
									<path d="M15.25 8a.75.75 0 0 1-.75.75H8.75v5.75a.75.75 0 0 1-1.5 0V8.75H1.5a.75.75 0 0 1 0-1.5h5.75V1.5a.75.75 0 0 1 1.5 0v5.75h5.75a.75.75 0 0 1 .75.75"></path>
								</svg>
							</Button>
						</DropdownMenuTrigger>
						<DropdownMenuContent align="start" className="w-56 bg-[#282828] border-none text-white p-1">
							<DropdownMenuItem
								onClick={() => setEditPlaylistDetailsModalOpen(true, null)}
								className="flex items-center gap-3 px-3 py-3 hover:bg-[#3e3e3e] cursor-pointer rounded"
							>
								<svg
									viewBox="0 0 24 24"
									fill="currentColor"
									className="w-6 h-6"
								>
									<path d="M15 4H9v8H1v12h6v-6h6v6h6V12h-4V4zm-2 10H11v-2h2v2z" />
								</svg>
								<div className="flex-1">
									<div className="text-white font-medium text-base">Playlist</div>
									<div className="text-[#a7a7a7] text-sm">
										Create a playlist with songs or episodes
									</div>
								</div>
							</DropdownMenuItem>
							<DropdownMenuItem
								className="flex items-center gap-3 px-3 py-3 hover:bg-[#3e3e3e] cursor-pointer rounded opacity-50"
								disabled
							>
								<svg
									viewBox="0 0 24 24"
									fill="currentColor"
									className="w-6 h-6"
								>
									<circle cx="12" cy="12" r="10" opacity="0.3" />
									<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z" />
								</svg>
								<div className="flex-1">
									<div className="text-white font-medium text-base">Blend</div>
									<div className="text-[#a7a7a7] text-sm">
										Combine your friends' tastes into a playlist
									</div>
								</div>
							</DropdownMenuItem>
							<DropdownMenuItem
								className="flex items-center gap-3 px-3 py-3 hover:bg-[#3e3e3e] cursor-pointer rounded opacity-50"
								disabled
							>
								<svg
									viewBox="0 0 24 24"
									fill="currentColor"
									className="w-6 h-6"
								>
									<path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z" />
								</svg>
								<div className="flex-1">
									<div className="text-white font-medium text-base">Folder</div>
									<div className="text-[#a7a7a7] text-sm">
										Organise your playlists
									</div>
								</div>
							</DropdownMenuItem>
						</DropdownMenuContent>
					</DropdownMenu>
				</div>
			</div>

			{/* Tabs: Playlists, Artists, Albums */}
			<div className="flex gap-2 px-2 py-1">
				<Button
					variant="ghost"
					size="sm"
					className={`text-sm rounded-full px-3 h-8 font-normal transition-all ${
						activeTab === "playlists"
							? "bg-[#2a2a2a] text-white hover:bg-[#2a2a2a]"
							: "bg-transparent text-[#b3b3b3] hover:bg-[#1a1a1a]"
					}`}
					onClick={() => setActiveTab("playlists")}
				>
					Playlists
				</Button>
				<Button
					variant="ghost"
					size="sm"
					className={`text-sm rounded-full px-3 h-8 font-normal transition-all ${
						activeTab === "artists"
							? "bg-[#2a2a2a] text-white hover:bg-[#2a2a2a]"
							: "bg-transparent text-[#b3b3b3] hover:bg-[#1a1a1a]"
					}`}
					onClick={() => setActiveTab("artists")}
				>
					Artists
				</Button>
				<Button
					variant="ghost"
					size="sm"
					className={`text-sm rounded-full px-3 h-8 font-normal transition-all ${
						activeTab === "albums"
							? "bg-[#2a2a2a] text-white hover:bg-[#2a2a2a]"
							: "bg-transparent text-[#b3b3b3] hover:bg-[#1a1a1a]"
					}`}
					onClick={() => setActiveTab("albums")}
				>
					Albums
				</Button>
			</div>

			{/* Sort and View Controls */}
			<div className="flex justify-between items-center px-3 py-2">
				{/* Search Icon */}
				<Button
					variant="ghost"
					size="icon"
					className="h-8 w-8 text-[#b3b3b3] hover:text-white hover:bg-transparent"
				>
					<svg
						viewBox="0 0 16 16"
						fill="currentColor"
						className="w-4 h-4"
					>
						<path d="M7 1.75a5.25 5.25 0 1 0 0 10.5 5.25 5.25 0 0 0 0-10.5zM.25 7a6.75 6.75 0 1 1 12.096 4.12l3.184 3.185a.75.75 0 1 1-1.06 1.06L11.304 12.18A6.75 6.75 0 0 1 .25 7z"></path>
					</svg>
				</Button>

				{/* Sort By Dropdown */}
				<DropdownMenu>
					<DropdownMenuTrigger asChild>
						<Button
							variant="ghost"
							size="sm"
							className="h-8 text-sm text-[#b3b3b3] hover:text-white px-2 gap-2 hover:bg-transparent"
						>
							{sortBy === "recents" && "Recents"}
							{sortBy === "recently_added" && "Recently Added"}
							{sortBy === "alphabetical" && "Alphabetical"}
							{sortBy === "creator" && "Creator"}
							<svg
								viewBox="0 0 16 16"
								fill="currentColor"
								className="w-4 h-4"
							>
								<path d="M15 14.5H5V13h10z M15 11H5V9.5h10z M15 7.5H5V6h10z M3 3v11l-2-1.5" />
							</svg>
						</Button>
					</DropdownMenuTrigger>
					<DropdownMenuContent align="start" className="w-48 bg-[#282828] border-none text-white">
						<DropdownMenuLabel className="text-xs text-[#a7a7a7] px-3 py-2">
							Sort by
						</DropdownMenuLabel>
						<DropdownMenuItem
							onClick={() => setSortBy("recents")}
							className="flex justify-between px-3 py-2 hover:bg-[#3e3e3e] cursor-pointer"
						>
							<span>Recents</span>
							{sortBy === "recents" && (
								<svg
									xmlns="http://www.w3.org/2000/svg"
									viewBox="0 0 16 16"
									fill="currentColor"
									className="w-4 h-4 text-green-500"
								>
									<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.75.75 0 0 1 1.06-1.06L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0"></path>
								</svg>
							)}
						</DropdownMenuItem>
						<DropdownMenuItem
							onClick={() => setSortBy("recently_added")}
							className="flex justify-between px-3 py-2 hover:bg-[#3e3e3e] cursor-pointer"
						>
							<span>Recently Added</span>
							{sortBy === "recently_added" && (
								<svg
									xmlns="http://www.w3.org/2000/svg"
									viewBox="0 0 16 16"
									fill="currentColor"
									className="w-4 h-4 text-green-500"
								>
									<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.75.75 0 0 1 1.06-1.06L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0"></path>
								</svg>
							)}
						</DropdownMenuItem>
						<DropdownMenuItem
							onClick={() => setSortBy("alphabetical")}
							className="flex justify-between px-3 py-2 hover:bg-[#3e3e3e] cursor-pointer"
						>
							<span>Alphabetical</span>
							{sortBy === "alphabetical" && (
								<svg
									xmlns="http://www.w3.org/2000/svg"
									viewBox="0 0 16 16"
									fill="currentColor"
									className="w-4 h-4 text-green-500"
								>
									<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.75.75 0 0 1 1.06-1.06L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0"></path>
								</svg>
							)}
						</DropdownMenuItem>
						<DropdownMenuItem
							onClick={() => setSortBy("creator")}
							className="flex justify-between px-3 py-2 hover:bg-[#3e3e3e] cursor-pointer"
						>
							<span>Creator</span>
							{sortBy === "creator" && (
								<svg
									xmlns="http://www.w3.org/2000/svg"
									viewBox="0 0 16 16"
									fill="currentColor"
									className="w-4 h-4 text-green-500"
								>
									<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.75.75 0 0 1 1.06-1.06L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0"></path>
								</svg>
							)}
						</DropdownMenuItem>
						<DropdownMenuSeparator className="bg-[#3e3e3e]" />
						<DropdownMenuLabel className="text-xs text-[#a7a7a7] px-3 py-2">
							View as
						</DropdownMenuLabel>
						<DropdownMenuItem
							onClick={() => setViewAs("list")}
							className="flex justify-between px-3 py-2 hover:bg-[#3e3e3e] cursor-pointer"
						>
							<div className="flex items-center gap-2">
								<svg
									xmlns="http://www.w3.org/2000/svg"
									viewBox="0 0 16 16"
									fill="currentColor"
									className="w-4 h-4"
								>
									<path d="M0 1.75A.75.75 0 0 1 .75 1h14.5a.75.75 0 0 1 0 1.5H.75A.75.75 0 0 1 0 1.75zm0 6A.75.75 0 0 1 .75 7h14.5a.75.75 0 0 1 0 1.5H.75A.75.75 0 0 1 0 7.75zm0 6a.75.75 0 0 1 .75-.75h14.5a.75.75 0 0 1 0 1.5H.75a.75.75 0 0 1-.75-.75z"></path>
								</svg>
								<span>Compact</span>
							</div>
							{viewAs === "list" && (
								<svg
									xmlns="http://www.w3.org/2000/svg"
									viewBox="0 0 16 16"
									fill="currentColor"
									className="w-4 h-4 text-green-500"
								>
									<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.75.75 0 0 1 1.06-1.06L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0"></path>
								</svg>
							)}
						</DropdownMenuItem>
						<DropdownMenuItem
							onClick={() => setViewAs("grid")}
							className="flex justify-between px-3 py-2 hover:bg-[#3e3e3e] cursor-pointer"
						>
							<div className="flex items-center gap-2">
								<svg
									xmlns="http://www.w3.org/2000/svg"
									viewBox="0 0 16 16"
									fill="currentColor"
									className="w-4 h-4"
								>
									<path d="M0 0h6v6H0zm0 10h6v6H0zm10 0h6v6h-6zm0-10h6v6h-6z"></path>
								</svg>
								<span>Grid</span>
							</div>
							{viewAs === "grid" && (
								<svg
									xmlns="http://www.w3.org/2000/svg"
									viewBox="0 0 16 16"
									fill="currentColor"
									className="w-4 h-4 text-green-500"
								>
									<path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.75.75 0 0 1 1.06-1.06L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0"></path>
								</svg>
							)}
						</DropdownMenuItem>
					</DropdownMenuContent>
				</DropdownMenu>
			</div>

			{/* Content Area */}
			<div className="flex flex-col gap-0 px-2 flex-1 overflow-y-auto">
				{activeTab === "playlists" &&
					sortedPlaylists.map((playlist) => (
						<SidebarItem
							key={playlist.id}
							id={String(playlist.id)}
							title={playlist.name}
							tracks={playlist.tracks}
							description={playlist.description}
							image={playlist.image}
							href={`/playlist/${playlist.id}`}
							onClose={isMobile ? onClose : undefined}
							isMobile={isMobile}
							isLikedSongs={playlist.is_default}
						/>
					))}

				{activeTab === "artists" &&
					(followedArtists.length > 0 ? (
						followedArtists.map((artist) => (
							<SidebarItem
								key={artist.id}
								id={String(artist.id)}
								title={artist.name}
								tracks={[]}
								description="Artist"
								image={artist.image}
								href={`/artist/${artist.id}`}
								onClose={isMobile ? onClose : undefined}
								isMobile={isMobile}
							/>
						))
					) : (
						<div className="flex flex-col items-center justify-center h-64 text-[#b3b3b3]">
							<svg
								xmlns="http://www.w3.org/2000/svg"
								viewBox="0 0 24 24"
								fill="currentColor"
								className="w-16 h-16 mb-4 opacity-50"
							>
								<path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"></path>
							</svg>
							<p className="text-sm font-medium">No artists yet</p>
							<p className="text-xs mt-1">
								Follow artists to see them here
							</p>
						</div>
					))}

				{activeTab === "albums" &&
					(savedAlbums.length > 0 ? (
						savedAlbums.map((album) => (
							<SidebarItem
								key={album.id}
								id={String(album.id)}
								title={album.name}
								tracks={[]}
								description={`Album â€¢ ${album.artist}`}
								image={album.cover}
								href={`/albums/${album.id}`}
								onClose={isMobile ? onClose : undefined}
								isMobile={isMobile}
							/>
						))
					) : (
						<div className="flex flex-col items-center justify-center h-64 text-[#b3b3b3]">
							<svg
								xmlns="http://www.w3.org/2000/svg"
								viewBox="0 0 24 24"
								fill="currentColor"
								className="w-16 h-16 mb-4 opacity-50"
							>
								<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 14.5c-2.49 0-4.5-2.01-4.5-4.5S9.51 7.5 12 7.5s4.5 2.01 4.5 4.5-2.01 4.5-4.5 4.5zm0-5.5c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1z"></path>
							</svg>
							<p className="text-sm font-medium">No albums yet</p>
							<p className="text-xs mt-1">
								Save albums to see them here
							</p>
						</div>
					))}
			</div>
		</div>
	)
}
